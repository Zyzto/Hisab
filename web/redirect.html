<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Hisab - Redirecting...</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;text-align:center;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:#fafafa;color:#333}
.card{max-width:360px;width:100%;padding:40px 24px;background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.08)}
h3{font-size:1.25rem;margin-bottom:8px}
p{color:#666;margin-bottom:20px;font-size:.95rem}
.spinner{width:32px;height:32px;border:3px solid #e0e0e0;border-top-color:#007AFF;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 20px}
@keyframes spin{to{transform:rotate(360deg)}}
.btn{display:inline-block;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:600;font-size:.95rem;transition:background .2s,border-color .2s}
.btn-primary{background:#007AFF;color:#fff}
.btn-primary:hover{background:#0062cc}
.btn-outline{background:transparent;color:#007AFF;border:2px solid #007AFF}
.btn-outline:hover{background:#f0f4ff}
.btn + .btn{margin-top:12px}
.error-icon{font-size:48px;margin-bottom:12px}
</style>
</head>
<body>
<div class="card" id="content">
  <div class="spinner" id="spinner"></div>
  <h3 id="heading" data-i18n="redirect.heading">Opening Hisab...</h3>
  <p id="message" data-i18n="redirect.message">If nothing happens, tap the button below.</p>
  <a id="openApp" href="#" class="btn btn-primary" style="display:none" data-i18n="redirect.openInApp">Open in Hisab</a>
  <a id="fallback" href="#" class="btn btn-outline" style="display:none" data-i18n="redirect.openInBrowser">Open in Browser</a>
</div>

<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  var token = params.get("token");
  var error = params.get("error");

  var heading = document.getElementById("heading");
  var message = document.getElementById("message");
  var openApp = document.getElementById("openApp");
  var fallback = document.getElementById("fallback");
  var spinner = document.getElementById("spinner");

  // Error state
  if (error || !token) {
    spinner.style.display = "none";
    heading.textContent = "Error";
    message.textContent = error === "expired"
      ? "This invite link is invalid or expired."
      : "Missing or invalid invite link.";
    openApp.style.display = "none";
    fallback.style.display = "none";
    return;
  }

  var encodedToken = encodeURIComponent(token);
  var webUrl = window.location.origin + "/invite?token=" + encodedToken;

  // Set fallback button (web/PWA)
  fallback.href = webUrl;

  // Detect platform
  var ua = navigator.userAgent || "";
  var isAndroid = /android/i.test(ua);
  var isIOS = /iphone|ipad|ipod/i.test(ua);
  var isMobile = isAndroid || isIOS || /mobile/i.test(ua);

  // Desktop: go straight to web app (no desktop app)
  if (!isMobile) {
    window.location.replace(webUrl);
    return;
  }

  // Mobile: show "Open in Hisab app" and "Continue in browser" (user choice, no auto-redirect)
  var appUrl;
  if (isAndroid) {
    appUrl = "intent://invite?token=" + encodedToken
      + "#Intent"
      + ";scheme=io.supabase.hisab"
      + ";package=com.shenepoy.hisab"
      + ";S.browser_fallback_url=" + encodeURIComponent(webUrl)
      + ";end";
  } else {
    appUrl = "io.supabase.hisab://invite?token=" + encodedToken;
  }
  openApp.href = appUrl;
  fallback.href = webUrl;
  heading.textContent = "You have a group invite";
  message.textContent = "You can open the invite in the Hisab app or continue in the browser to sign in and accept it.";
  openApp.textContent = "Open in Hisab app";
  fallback.textContent = "Continue in browser";
  openApp.style.display = "inline-block";
  fallback.style.display = "inline-block";
  spinner.style.display = "none";

  var hintEl = document.createElement("p");
  hintEl.id = "hint";
  hintEl.style.cssText = "color:#888;font-size:0.85rem;margin-top:24px;display:none";
  hintEl.textContent = "Didn't open? You can continue in the browser to sign in and accept the invite.";
  document.getElementById("content").appendChild(hintEl);

  var tapHintEl = document.createElement("p");
  tapHintEl.style.cssText = "color:#555;font-size:0.9rem;margin-bottom:12px";
  tapHintEl.textContent = "Tap below to open in the app.";
  document.getElementById("content").insertBefore(tapHintEl, openApp);

  // After 8s, show hint if still on page (no auto-redirect)
  setTimeout(function() {
    var h = document.getElementById("hint");
    if (h) h.style.display = "block";
  }, 8000);
})();
</script>
</body>
</html>
